# Prometheus Alert Rules for Prompt Builder API
#
# These alerts trigger when performance or availability issues occur
# Alerts are sent to Alertmanager, which can route to Slack, PagerDuty, etc.

groups:
  - name: api_performance
    interval: 30s
    rules:
      # High API response time
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: 'High API latency detected'
          description: 'P95 response time is {{ $value | humanizeDuration }} (threshold: 10s)'

      # Very high API response time
      - alert: VeryHighAPILatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 30
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: 'Critical API latency detected'
          description: 'P95 response time is {{ $value | humanizeDuration }} (threshold: 30s)'

      # High error rate
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: 'High error rate detected'
          description: 'Error rate is {{ $value | humanizePercentage }} (threshold: 5%)'

      # Very high error rate
      - alert: VeryHighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.15
        for: 2m
        labels:
          severity: critical
          component: api
        annotations:
          summary: 'Critical error rate detected'
          description: 'Error rate is {{ $value | humanizePercentage }} (threshold: 15%)'

  - name: claude_api
    interval: 30s
    rules:
      # Claude API circuit breaker open
      - alert: ClaudeAPICircuitBreakerOpen
        expr: circuit_breaker_state{circuit="claude-api"} == 1
        for: 1m
        labels:
          severity: critical
          component: claude-api
        annotations:
          summary: 'Claude API circuit breaker is OPEN'
          description: 'The Claude API circuit breaker has opened, indicating repeated failures'

      # High Claude API error rate
      - alert: HighClaudeAPIErrorRate
        expr: rate(claude_api_calls_total{status="error"}[5m]) / rate(claude_api_calls_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: claude-api
        annotations:
          summary: 'High Claude API error rate'
          description: 'Claude API error rate is {{ $value | humanizePercentage }} (threshold: 10%)'

      # Slow Claude API responses
      - alert: SlowClaudeAPIResponses
        expr: histogram_quantile(0.95, rate(claude_api_duration_seconds_bucket[5m])) > 45
        for: 5m
        labels:
          severity: warning
          component: claude-api
        annotations:
          summary: 'Slow Claude API responses'
          description: 'P95 Claude API response time is {{ $value | humanizeDuration }} (threshold: 45s)'

  - name: cache_performance
    interval: 30s
    rules:
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: cache_hit_rate < 30
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: 'Low cache hit rate'
          description: 'Cache hit rate is {{ $value }}% (threshold: 30%)'

      # Very low cache hit rate
      - alert: VeryLowCacheHitRate
        expr: cache_hit_rate < 10
        for: 5m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: 'Very low cache hit rate'
          description: 'Cache hit rate is {{ $value }}% (threshold: 10%)'

  - name: resource_usage
    interval: 30s
    rules:
      # High memory usage
      - alert: HighMemoryUsage
        expr: (process_resident_memory_bytes / 1024 / 1024) > 1024
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: 'High memory usage'
          description: 'Memory usage is {{ $value | humanize }}MB (threshold: 1GB)'

      # Critical memory usage
      - alert: CriticalMemoryUsage
        expr: (process_resident_memory_bytes / 1024 / 1024) > 2048
        for: 2m
        labels:
          severity: critical
          component: system
        annotations:
          summary: 'Critical memory usage'
          description: 'Memory usage is {{ $value | humanize }}MB (threshold: 2GB)'

      # High CPU usage
      - alert: HighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: system
        annotations:
          summary: 'High CPU usage'
          description: 'CPU usage is {{ $value | humanizePercentage }} (threshold: 80%)'

      # Too many active requests
      - alert: HighConcurrentRequests
        expr: http_active_requests > 100
        for: 5m
        labels:
          severity: warning
          component: api
        annotations:
          summary: 'High number of concurrent requests'
          description: 'Active requests: {{ $value }} (threshold: 100)'

  - name: availability
    interval: 30s
    rules:
      # Service down
      - alert: ServiceDown
        expr: up{job="prompt-builder-api"} == 0
        for: 1m
        labels:
          severity: critical
          component: api
        annotations:
          summary: 'Service is down'
          description: 'The Prompt Builder API is not responding to health checks'

      # High request rate (potential DDoS)
      - alert: UnusuallyHighRequestRate
        expr: rate(http_requests_total[5m]) > 1000
        for: 2m
        labels:
          severity: warning
          component: api
        annotations:
          summary: 'Unusually high request rate'
          description: 'Request rate is {{ $value | humanize }} req/s (threshold: 1000)'
